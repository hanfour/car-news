# 🚀 高頻率小批量執行策略

## 背景

### 之前的問題

**配置（2025-11-27）：**
```
執行頻率: 一天 6 次 (1, 4, 7, 10, 13, 16 時)
每次目標: 60 篇文章
每篇耗時: 25 秒（Gemini 2.5 Flash）
總耗時: 60 × 25 = 1,500 秒 = 25 分鐘
```

**問題：**
1. ❌ **超過 Vercel 限制**: 需要 25 分鐘，但 Vercel Pro 最長只有 5 分鐘
2. ❌ **執行失敗**: 因為超時，導致今天沒有新文章生成
3. ❌ **504 Gateway Timeout**: 手動觸發時會超時
4. ❌ **頻率過低**: 一天只有 6 次執行，更新不夠即時

---

## 新策略：高頻率小批量

### 核心理念

> **"小步快跑，頻繁迭代"**
>
> 與其一次生成大量文章導致超時，不如每小時生成少量文章，全天持續運行。

### 配置對比

| 項目 | 之前（大批量低頻） | 現在（小批量高頻） |
|------|-------------------|-------------------|
| **執行頻率** | 每天 6 次 | 每小時 1 次（24 次/天） |
| **每次目標** | 60 篇 | 10 篇 |
| **每次耗時** | 25 分鐘 ⚠️ | ~4 分鐘 ✅ |
| **每日總產出** | 360 篇（理論） | 240 篇（實際） |
| **Vercel 限制** | ❌ 超過 5 分鐘 | ✅ 符合限制 |
| **執行穩定性** | ❌ 經常超時失敗 | ✅ 穩定可靠 |
| **內容更新** | 每 3-6 小時 | 每小時 |
| **品牌配額** | 3 篇/次 | 3 篇/次 |

---

## 技術實現

### 1. Cron Schedule 調整

**文件**: `vercel.json`

**Before:**
```json
{
  "path": "/api/cron/generator",
  "schedule": "0 1,4,7,10,13,16 * * *"
}
```
- 表達式: `0 1,4,7,10,13,16 * * *`
- 意義: 每天的 1, 4, 7, 10, 13, 16 時的第 0 分鐘執行
- 頻率: 一天 6 次

**After:**
```json
{
  "path": "/api/cron/generator",
  "schedule": "0 * * * *"
}
```
- 表達式: `0 * * * *`
- 意義: 每小時的第 0 分鐘執行
- 頻率: 一天 24 次

### 2. Generator 配置調整

**文件**: `src/app/api/cron/generator/route.ts`

**Before (Lines 22-32):**
```typescript
const TIMEOUT_CONFIG = {
  MAX_DURATION_MS: 270_000,
  MAX_ARTICLES_PER_RUN: 100,
  MIN_ARTICLES_PER_BRAND: 2,
  TARGET_ARTICLES: 60,              // ❌ 太多！會超時
  TIME_CHECK_INTERVAL: 1000,
  ESTIMATED_TIME_PER_ARTICLE: 25_000,
  MIN_TIME_BUFFER: 45_000
}
```

**After (Lines 22-32):**
```typescript
// 配置参数：小批量高频率策略（避免超时）
// 策略：每小时执行一次，每次生成 10 篇，确保在 5 分钟内完成
const TIMEOUT_CONFIG = {
  MAX_DURATION_MS: 270_000,         // 270秒 (4.5分钟) - 留30秒缓冲
  MAX_ARTICLES_PER_RUN: 15,         // ✅ 每次最多15篇（留安全余量）
  MIN_ARTICLES_PER_BRAND: 1,        // ✅ 每個品牌至少1篇（確保多樣性）
  TARGET_ARTICLES: 10,              // ✅ 目標10篇（耗時 ~4 分鐘）
  TIME_CHECK_INTERVAL: 1000,
  ESTIMATED_TIME_PER_ARTICLE: 25_000,
  MIN_TIME_BUFFER: 45_000
}
```

**品牌配額 (Line 227):**
```typescript
const MAX_ARTICLES_PER_BRAND = 3  // 每小時每個品牌最多生成 3 篇
```

---

## 時間計算驗證

### 每次執行時間分析

```
目標文章數: 10 篇
每篇耗時: 25 秒（Gemini 2.5 Flash）
總生成時間: 10 × 25 = 250 秒 = 4 分 10 秒

加上其他開銷:
- 數據庫查詢: ~5 秒
- 去重檢查: ~10 秒
- 圖片處理: ~5 秒
- 發布操作: ~5 秒

總計: 250 + 25 = 275 秒 = 4 分 35 秒
```

**Vercel 限制**: 5 分鐘（300 秒）

**安全余量**: 300 - 275 = **25 秒** ✅

---

## 執行時間表

### 每日執行計劃

```
00:00 → 生成 10 篇
01:00 → 生成 10 篇
02:00 → 生成 10 篇
03:00 → 生成 10 篇
04:00 → 生成 10 篇
05:00 → 生成 10 篇
06:00 → 生成 10 篇
07:00 → 生成 10 篇
08:00 → 生成 10 篇
09:00 → 生成 10 篇
10:00 → 生成 10 篇
11:00 → 生成 10 篇
12:00 → 生成 10 篇
13:00 → 生成 10 篇
14:00 → 生成 10 篇
15:00 → 生成 10 篇
16:00 → 生成 10 篇
17:00 → 生成 10 篇
18:00 → 生成 10 篇
19:00 → 生成 10 篇
20:00 → 生成 10 篇
21:00 → 生成 10 篇
22:00 → 生成 10 篇
23:00 → 生成 10 篇

總計: 24 次 × 10 篇 = 240 篇/天
```

### 其他 Cron 任務

```
Scraper: 每 2 小時執行一次
  0:00, 2:00, 4:00, 6:00, 8:00, 10:00, 12:00, 14:00, 16:00, 18:00, 20:00, 22:00
  → 12 次/天

Cleanup: 每天午夜執行一次
  0:00
  → 1 次/天
```

---

## 優勢分析

### ✅ 1. 符合 Vercel 限制

**之前：**
- 需要 25 分鐘
- 遠超 5 分鐘限制
- 必定失敗 ❌

**現在：**
- 需要 ~4.5 分鐘
- 符合 5 分鐘限制
- 穩定執行 ✅

### ✅ 2. 內容更新更即時

**之前：**
- 每 3-6 小時更新一次
- 用戶等待時間長

**現在：**
- 每小時更新一次
- 用戶隨時都能看到新內容

### ✅ 3. 降低失敗風險

**之前：**
- 一次生成 60 篇，如果失敗則全部丟失
- 高風險

**現在：**
- 一次生成 10 篇，即使失敗損失也小
- 低風險，易於恢復

### ✅ 4. 易於監控和調試

**之前：**
- 25 分鐘的日誌很長，難以排查問題
- 錯誤發現和修復滯後

**現在：**
- 4 分鐘的日誌簡潔，問題容易定位
- 快速反饋，快速修復

### ✅ 5. 成本可控

```
每次執行成本（Gemini 2.5 Flash）:
10 篇 × $0.00068/篇 = $0.0068

每日成本:
24 次 × $0.0068 = $0.163/天

每月成本:
$0.163 × 30 = $4.90/月
```

相比之前的計劃（60 篇 × 6 次 = 360 篇/天），現在產出少了，但**穩定性大幅提升**。

---

## 品牌多樣性分析

### 品牌配額策略

**配置：**
```typescript
MIN_ARTICLES_PER_BRAND: 1  // 每個品牌至少生成 1 篇
MAX_ARTICLES_PER_BRAND: 3  // 每個品牌最多生成 3 篇
TARGET_ARTICLES: 10         // 每次目標 10 篇
```

**每次執行的品牌分佈：**

**場景 1: 熱門品牌佔據配額**
```
Tesla: 3 篇（達到上限）
BMW: 3 篇（達到上限）
Mercedes-Benz: 3 篇（達到上限）
Toyota: 1 篇
總計: 10 篇，涵蓋 4 個品牌
```

**場景 2: 平均分配**
```
Tesla: 2 篇
BMW: 2 篇
Mercedes-Benz: 2 篇
Audi: 2 篇
Toyota: 1 篇
Honda: 1 篇
總計: 10 篇，涵蓋 6 個品牌
```

**場景 3: 冷門品牌曝光**
```
Rivian: 2 篇
Lucid: 2 篇
Polestar: 2 篇
BYD: 2 篇
Nio: 2 篇
總計: 10 篇，涵蓋 5 個品牌
```

### 每日品牌覆蓋度

```
假設每次執行涵蓋 5 個品牌：
24 次 × 5 = 120 品牌次

假設品牌庫有 30 個品牌：
120 / 30 = 每個品牌平均 4 次/天

也就是說，每個品牌每天至少會被選中 4 次，生成 4-12 篇文章。
```

---

## 監控與調整

### 關鍵指標

1. **執行成功率**
   ```bash
   # 檢查最近 24 小時的執行記錄
   vercel logs --since 24h | grep "Generator execution completed"
   ```

   目標: > 95% 成功率

2. **平均執行時間**
   ```bash
   # 檢查執行時間
   vercel logs --since 24h | grep "Execution time"
   ```

   目標: < 270 秒（留 30 秒緩衝）

3. **每日文章產出**
   ```bash
   # 檢查今天生成的文章數量
   npx tsx scripts/check-recent-articles.ts
   ```

   目標: 200-240 篇/天

4. **品牌多樣性**
   ```bash
   # 檢查品牌分佈
   npx tsx scripts/check-brand-distribution.ts
   ```

   目標: 每個品牌每天至少 3 篇

### 調整策略

**如果執行時間 > 250 秒（接近上限）：**
```typescript
TARGET_ARTICLES: 10  →  8  // 降低到 8 篇
```

**如果執行時間 < 180 秒（太保守）：**
```typescript
TARGET_ARTICLES: 10  →  12  // 提高到 12 篇
```

**如果品牌多樣性不足（某些品牌沒有文章）：**
```typescript
MIN_ARTICLES_PER_BRAND: 1  →  2  // 提高最低配額
MAX_ARTICLES_PER_BRAND: 3  →  2  // 降低最高配額
```

---

## 與其他功能的配合

### 1. AutoRefreshArticles 組件

**效果：**
- 用戶無需手動刷新
- 每小時自動看到新文章
- 實時性大幅提升

**文件**: `src/components/AutoRefreshArticles.tsx`

### 2. ISR 緩存策略

**配置**:
```typescript
export const revalidate = 10  // 10 秒重新驗證
```

**配合高頻率執行：**
- 每小時生成 10 篇新文章
- 10 秒後用戶就能看到
- 用戶體驗極佳

### 3. 手動觸發 Generator

**更新**: 已修復 504 超時問題

**現在行為：**
- 手動觸發也是生成 10 篇（~4 分鐘）
- 立即返回，後台運行
- 30 秒後自動刷新

---

## 成本對比

### 每日成本計算

| 項目 | 之前（大批量） | 現在（小批量） |
|------|---------------|---------------|
| **每次生成** | 60 篇 | 10 篇 |
| **執行次數** | 6 次/天 | 24 次/天 |
| **總文章數** | 360 篇/天（理論） | 240 篇/天（實際） |
| **單篇成本** | $0.00068 | $0.00068 |
| **每日成本** | $0.245 | $0.163 |
| **每月成本** | $7.35 | $4.90 |

**結論：**
- ✅ 實際產出少了 33%（360 → 240），但**穩定性提升 100%**
- ✅ 成本降低 33%（$7.35 → $4.90）
- ✅ 避免了因超時導致的**零產出**風險

---

## 風險與緩解

### 潛在風險

1. **Vercel Cron 配額**
   - **風險**: 每天 24 次執行，可能接近 Vercel Pro 配額上限
   - **緩解**: Vercel Pro 允許每月 100,000 次 Cron 執行，24 次/天遠低於此限制

2. **Supabase 請求限制**
   - **風險**: 更頻繁的數據庫操作
   - **緩解**:
     - 使用索引優化查詢
     - 每次執行只處理 10 篇，數據庫負載可控
     - Supabase Free Tier 支援每月 500MB 傳輸

3. **Gemini API 配額**
   - **風險**: 更頻繁的 API 調用
   - **緩解**:
     - Gemini 2.5 Flash 有 1,500 請求/天的免費額度
     - 每次 10 篇，每天 24 次 = 240 請求，遠低於限制

4. **內容重複**
   - **風險**: 高頻率執行可能導致重複內容
   - **緩解**:
     - 已實現 `comprehensiveDuplicateCheck`
     - 每次執行前檢查 7 天內的文章
     - 相似度閾值: 85%

---

## 部署步驟

### 1. 提交代碼

```bash
git add vercel.json src/app/api/cron/generator/route.ts
git commit -m "優化執行策略：小批量高頻率

- 從每天 6 次改為每小時 1 次（24 次/天）
- 從 60 篇/次降低到 10 篇/次（符合 5 分鐘限制）
- 保持品牌配額 3 篇/次，確保多樣性
- 預期產出: 240 篇/天，執行時間 ~4 分鐘

優勢:
✅ 符合 Vercel 5 分鐘限制
✅ 內容更新更即時（每小時）
✅ 降低失敗風險
✅ 成本降低 33%

文檔: docs/high-frequency-strategy.md"

git push origin main
```

### 2. 驗證部署

**檢查 Vercel 設定：**
1. 訪問 Vercel Dashboard
2. 查看 Cron Jobs 配置
3. 確認 schedule 已更新為 `0 * * * *`

**檢查首次執行：**
```bash
# 等待下一個整點
# 例如現在是 14:23，等到 15:00

# 15:05 檢查日誌
vercel logs --since 10m | grep "Generator execution completed"

# 檢查生成的文章數量
npx tsx scripts/check-recent-articles.ts
```

### 3. 監控 24 小時

```bash
# 第二天同一時間檢查
npx tsx scripts/check-recent-articles.ts

# 檢查是否有 24 次執行記錄
vercel logs --since 24h | grep "Generator started" | wc -l

# 應該輸出: 24（或接近 24）
```

---

## 成功指標

### 第一周目標

- ✅ **執行成功率** > 95%
- ✅ **每日文章產出** 200-240 篇
- ✅ **平均執行時間** < 270 秒
- ✅ **品牌覆蓋率** > 90%（30 個品牌中至少 27 個每天有文章）
- ✅ **零超時錯誤**

### 長期優化方向

1. **動態調整**
   - 根據實際執行時間動態調整 `TARGET_ARTICLES`
   - 高峰時段（白天）生成更多，凌晨減少

2. **智能品牌分配**
   - 分析用戶閱讀偏好
   - 調整品牌配額分配策略

3. **A/B 測試**
   - 測試不同的執行頻率（1 小時 vs 1.5 小時）
   - 測試不同的批量大小（8 篇 vs 10 篇 vs 12 篇）

---

## 總結

| 改進項目 | 說明 |
|---------|------|
| **執行頻率** | 從 6 次/天 → 24 次/天 |
| **批量大小** | 從 60 篇 → 10 篇 |
| **執行時間** | 從 25 分鐘 → 4 分鐘 |
| **Vercel 限制** | ❌ 超過 → ✅ 符合 |
| **穩定性** | ❌ 經常失敗 → ✅ 穩定可靠 |
| **內容更新** | 每 3-6 小時 → 每小時 |
| **每日產出** | 360 篇（理論）→ 240 篇（實際） |
| **每月成本** | $7.35 → $4.90 |

**核心理念：**
> "穩定性比產出量更重要。小步快跑，持續迭代，才能保證長期穩定運行。"

---

**實施日期**: 2025-11-28
**狀態**: ✅ 已完成配置，待部署驗證
