# 社群通知系统 - Requirements Document

为汽车新闻平台添加通知系统，让用户在评论被回复、被点赞时收到通知，提高用户回访率和互动黏性。支持品牌/话题关注，当有新文章时推送通知。

## Core Features

### 1. 通知类型

| 类型 | 触发条件 | 优先级 |
|------|----------|--------|
| `reply` | 用户的评论被他人回复 | P0 |
| `comment_like` | 用户的评论被点赞 | P0 |
| `article_like` | 用户收藏的文章被点赞 | P2 (可选) |
| `new_article` | 关注的品牌/话题有新文章 | P1 |
| `mention` | 评论中被 @提及 | P2 (未来) |

### 2. 通知展示

- Header 导航栏显示铃铛图标
- 未读通知显示红色数字徽章
- 点击展开通知下拉列表（最近 20 条）
- 支持「全部标为已读」操作
- 点击单条通知跳转到对应内容

### 3. 品牌/话题关注

- 文章页和品牌页显示「关注」按钮
- 用户可关注特定品牌（如 Tesla、BMW）
- 用户可关注特定话题标签（如 #電動車）
- 关注后，新文章发布时推送通知

### 4. 通知聚合

- 同一文章的多个点赞聚合为一条通知
- 显示格式：「張三 和其他 5 人赞了你的评论」
- 24 小时内的相似通知自动聚合

## User Stories

### 评论互动通知
- As a **评论者**, I want **在我的评论被回复时收到通知**, so that **我可以及时参与讨论**
- As a **评论者**, I want **在我的评论被点赞时收到通知**, so that **我知道我的观点获得认可**

### 品牌关注
- As a **汽车爱好者**, I want **关注特定汽车品牌**, so that **第一时间获得该品牌的新闻**
- As a **用户**, I want **在 Header 看到未读通知数量**, so that **我知道有新消息需要查看**

### 通知管理
- As a **用户**, I want **一键标记所有通知为已读**, so that **快速清理通知**
- As a **用户**, I want **点击通知直接跳转到相关内容**, so that **快速查看详情**

## Acceptance Criteria

### P0 - 核心功能（必须完成）
- [ ] 评论被回复时，原评论作者收到通知
- [ ] 评论被点赞时，评论作者收到通知
- [ ] Header 显示铃铛图标和未读数徽章
- [ ] 点击铃铛展开通知列表
- [ ] 点击通知跳转到对应文章/评论位置
- [ ] 支持标记单条/全部通知为已读
- [ ] 未登录用户不显示通知功能

### P1 - 关注功能
- [ ] 品牌页/文章页显示「关注」按钮
- [ ] 用户可关注/取消关注品牌
- [ ] 用户可关注/取消关注话题标签
- [ ] 新文章发布时，向关注者推送通知
- [ ] 用户可在设置中管理关注列表

### P2 - 增强功能（可选）
- [ ] 通知聚合（多个点赞合并显示）
- [ ] 通知偏好设置（开关各类通知）
- [ ] Email 通知（每日摘要）
- [ ] 推送通知（PWA / Web Push）

## Non-functional Requirements

### 性能要求
- 通知查询响应时间 < 200ms
- 未读数徽章实时更新（或 < 5秒延迟）
- 通知列表支持分页加载
- 每用户最多保留 1000 条通知记录

### 安全要求
- 用户只能查看自己的通知
- 通知 API 需要身份验证
- RLS 策略保护数据隔离

### 兼容要求
- 与现有评论系统无缝集成
- 使用现有的 Supabase 认证系统
- 移动端响应式适配

### 数据一致性
- 使用 PostgreSQL Trigger 自动创建通知
- 删除评论时级联删除相关通知
- 取消点赞时删除对应通知
